<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <title>title</title>
      <link rel="stylesheet" type="text/css" href="../css/api.css"/>
  <style>
    .img{
      text-align: center;
      margin-top: 25px;
    }
    .inputs{
      margin: 5px auto 0px auto;
      text-align: center;
    }
    .inputs input{
      border: 1px solid gray;
      border-radius: 10px;
      width: 85%;
      height: 35px;
      margin: 10px auto 0px auto;
    }
    .getbutton{
      width:40%;
      height: 35px;
      background-color: inherit;
      border: 1px solid gray;
      border-radius: 45px;
    }
    .inputs .resigerbutton{
      border: 1px solid gray;
      width:30%;
      height: 45px;
      background-color: inherit;
      font-size: 20px;
      border-radius: 45px;
    }
    .footer{
      font-size: 25px;
      margin-top: 100px;
      text-align: center;
    }
    a:visited{color: black;}
    a:link{color: black;}
  </style>
  </head>
  <body style = "background-color: #ffffff;">
    <div class="img">
      <img src="../icon/icon150x150.png" alt="">
    </div>
    <!--onsubmit事件是在提交表单时触发-->
    <!-- return 一个函数：是指当函数的返回值位false时，表单不提交，为true时提交-->
    <!--mySumit函数中的参数this是指form调用该函数时会将form传入函数中-->
    <form id='register_form' class="inputs" method="post">
      <input type="text" name="username"    value="" placeholder="姓名">
      <input type="text" name="hospital"    value="" placeholder="所属医院">
      <input type="text" name="major"      value="" placeholder="所属科室" style="width:40%;">
      <input type="text" name="userid"  value="" placeholder="工号"  style="width:40%;">
      <input type="text" name="password"    value="" placeholder="设置密码">
      <input type="text" name="repassword"  value="" placeholder="再次输入密码">
      <input type="text" name="phonenumber" value="" placeholder="输入手机号">
      <div>
        <input type="text" name="code" value="" placeholder="输入验证码" style="width:40%;">
        <button type="button" name="button" class="getbutton" onclick = "getTextCode()">获取验证码</button>
        <br>
        <a href="#" style="margin-left:160px;font-size:13px">收不到验证码？</a>
      </div>
      <input type="button" name="" value="注册" class="resigerbutton" onclick = "mySubmit()">
    </form>
  </body>
  <script type="text/javascript" src="../script/api.js"></script>
  <script type="text/javascript" src="../script/hex_sha1.js" ></script>
  <script type="text/javascript">
  //定义formData对象
  var form,formData,moduleSMSSDK;
  //需要上传到数据库用户表以及医生表的数据
  var username,hospital,major,userid,password,repassword,phonenumber,code;
        apiready = function(){
            moduleSMSSDK = api.require('smssdk');
        };
        //开始注册
        function mySubmit(){
            form = document.getElementById('register_form');
            formData = new FormData(form);
            username = formData.get('username');
            hospital = formData.get('hospital');
            major = formData.get('major');
            userid = formData.get('userid');
            password = formData.get('password');
            repassword = formData.get('repassword');
            phonenumber = formData.get('phonenumber');
            code = formData.get('code');
            //判断用户是否填满自己的信息，以及验证码
            if(username && hospital && major && userid && password && repassword && phonenumber && code){
                //判断密码无误
                if(password == repassword)
                {
                    //提交验证码并注册
                    commitCode();
                }
                else {
                    $api.toast('密码不一致','注意',3000);
                }
            }
            else{
                $api.toast('请填入完整信息','注意',3000);
            }
        }


        //获取验证码
        function getTextCode(){
            form = document.getElementById('register_form');
            formData = new FormData(form);
            phonenumber = formData.get('phonenumber');
            if(!phonenumber)
            {
                $api.toast('请输入手机号码','注意',3000);
            }
            else{
                //zone一定要赋值，tempCode为模板id，可不赋值
        		var param = {zone:'86', phoneNumber:phonenumber,tempCode:''};
                moduleSMSSDK.getTextCode(param, function(ret, err){});
            }
		}

        //先让验证码判定正确，然后提交注册信息给服务器,并且获取融云的token
        function commitCode(){
            //验证码判定是否正确
			var param = {zone:'86',phoneNumber:phonenumber, code:code};
	        moduleSMSSDK.commitCode(param, function(ret, err){
	            if (err !== null && err !== undefined && err !== '') {
                    $api.toast('验证码错误','注意',3000);
                    return false;
                }
                //验证码判定正确后，开始注册
	            else {
                    //向服务器发送要注册的用户数据
                    var now = Date.now();
                    var appId = api.loadSecureValue({
                        sync: true,
                        key: 'MyAppId'
                    });        //应用Id
                    var appKey = api.loadSecureValue({
                        sync: true,
                        key: 'MyAppKey'
                    });        //应用key
                    var encryptAppKey = SHA2(appId+"UZ"+appKey+"UZ"+now)+"."+now;
                    api.ajax({
                    	    url: 'https://d.apicloud.com/mcm/api/user',//暂时不用tb_user
                    	    method: 'post',
                    	    dataType:"json",
                            headers: {
                                "X-APICloud-AppId": appId,
                                "X-APICloud-AppKey": encryptAppKey,
                            },
                            cache: false,
                    	    data: {
                                values: {
                                    "userid":userid,
                                    "username":username,//_user数据表必要
                                    "password":password,//_user数据表必要
                                    "name":username,
                                    "pwd":password,
                                    "tel":phonenumber,
                                    "dc_id":userid,
                                    "hospital":hospital,
                                    "major":major,
                    	        }
                    	    }
                    	}, function(ret, err) {
                            //如果用户注册成功，那么接着存储 “ID——名字” ，获取融云的token
                            if(ret)
                            {
                                $api.setStorage(userid,username);
                                //跳转到登录页（由于异步问题，把跳转代码放在了这里）
                                api.openWin({
                                        reload : true,
                                        name : 'login_or_register',
                                        url : 'login_or_register.html',
                                        hScrollBarEnabled : false
                                });
                                getToken(userid,username);
                            }
                            else {
                                alert("注册失败");
                            }
                        });
	        	}
	        });
		}

        //获取融云的token
        function getToken(userId,userName){
            var rong_appkey = api.loadSecureValue({
                sync: true,
                key: 'rong_appkey'
            });
            var rong_skey = api.loadSecureValue({
                sync: true,
                key: 'rong_skey'
            });
            var rong_random = Math.random();
            rong_random = rong_random.toString().substring(2,8);
            var rong_second = parseInt(new Date().getTime()/1000);
            var rong_str = rong_skey+rong_random+rong_second;
            rong_str = SHA2(rong_str);
                        api.ajax({
                              url:"http://api.cn.ronghub.com/user/getToken.json",//融云Http请求
                              method:"POST",
                              headers: {
                                 "App-Key":rong_appkey,			//开发者平台分配的 App Key。
                                 "Nonce": rong_random,			//随机数
                                 "Timestamp": rong_second,		//时间戳，从 1970 年 1 月 1 日 0 点 0 分 0 秒开始到现在的毫秒数。
                                 "Signature": rong_str,			//数据签名,使用SHA1哈希加密
                                 "Content-Type": "application/x-www-form-urlencoded"
                      },
                              data:{
                                 values:{
                                        "userId":userId,//这里先让用户id与name相同，测试
                                        "name":userName,
                                        //"portraitUri":rong_headimage
                                }
                             }
                      },function(ret,err){
                                var token=ret.token;
                                alert("得到融云token："+token);
                                alert(userId+"rong_token");
                                $api.setStorage(userId+"rong_token",token);
                  });
                }
  </script>
  </html>

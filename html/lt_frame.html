<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style type="text/css">
    <style type="text/css">
        .aui-chat .aui-chat-header {
                margin-bottom: 0px;
        }
        .aui-chat .aui-chat-content_img {
                color: #212121;
                font-size: 0.7rem;
                border-radius: 0.2rem;
                min-height: 2rem;
                min-width: 4rem;
                position: relative;
                padding: 0.3rem;
                max-width: 44%;
                word-break: break-all;
                word-wrap: break-word;
        }
        .aui-chat .aui-chat-content_img img {
                max-width: 100%;
                display: inline;
                border-radius: 0.2rem;
        }
        .aui-chat .aui-chat-left .aui-chat-content_img {
                background-color: #b3e5fc;
                float: left;
                left: 0.5rem;
        }
        .aui-chat .aui-chat-right .aui-chat-content_img {
                background-color: #ffffff;
                right: 0.5rem;
                float: right;
        }
        .voice {
                height: 1.3rem;
                line-height: 1.3rem;
                width: 4rem;
                position: relative;
                background-image: url(../image/ChatBox/stop.png);
                background-repeat: no-repeat;
                background-position: 0 -0.1rem;
                background-size: 1.4rem auto;
                padding-left: 1.4rem;
                color: #424242;
        }
    </style>
</head>
<body>
    <!--聊天信息窗口-->
    <section class="aui-chat" id="msglist"></section>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/hope/zepto.min.js" ></script>
<script type="text/javascript">
    //正则字符串
    var reg = /\[.+?\]/g;
    //自己与对方的ID、姓名、头像
    var myId,myName,myTx,friendId,friendName,friendTx;
    //录音开始时间，录音时长，聊天输入框，融云模块，录音路径，录音时长
    var time1='',time2='',chatBox,rong,yy,time_len;
    apiready = function(){
        api.parseTapmode();//优化点击事件（300）
        myId = api.pageParam.myId;
        myName = api.pageParam.myName;
        myTx = api.pageParam.myTx;
        friendId = api.pageParam.friendId;
        friendName = api.pageParam.friendName;
        friendTx = api.pageParam.friendTx;
        rong  = api.require('rongCloud2');
        //监听：当前窗口的用户（对方）向自己发送信息后，将信息绘制到窗口中
        api.addEventListener(
            {
                name: 'setOnReceiveMessageListener'
            },
            function(ret,err){
                if(ret && ret.value){
                var getFriendMessage = ret.value;    //获取到的对方信息
                var html = '';
                //如果当前消息的目标id等于当前会话目标id，写入
                if (getFriendMessage.result.message.targetId == friendId) {
                    //文字信息
                    if (getFriendMessage.result.message.objectName == 'RC:TxtMsg') {
                            txt = getFriendMessage.result.message.content.text.replace(reg, function(a, b) {
                                    return face[a] ? face[a] : a;
                            });
                            html += '<div class="aui-chat-header">' + sj(getFriendMessage.result.message.sentTime) + '</div>';
                            html += '<div class="aui-chat-item aui-chat-left">';
                            html += '          <div class="aui-chat-media"><img src="' + friendTx + '" /></div>';
                            html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + friendName + '</div>';
                            html += '               <div class="aui-chat-content">';
                            html += '                        <div class="aui-chat-arrow"></div>';
                            html += txt;
                            html += '               </div>';
                            html += '          </div>';
                            html += '</div>';
                    }
                    //图像信息
                    else if (getFriendMessage.result.message.objectName == 'RC:ImgMsg') {
                           html += '<div class="aui-chat-header">' + sj(getFriendMessage.result.message.sentTime) + '</div>';
                           html += '<div class="aui-chat-item aui-chat-left">';
                           html += '          <div class="aui-chat-media"><img src="' + friendTx + '" /></div>';
                           html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + friendName + '</div>';
                           html += '               <div class="aui-chat-content_img">';
                           html += '                        <div class="aui-chat-arrow"></div>';
                           html += '               <img onclick="openImage(\'' + getFriendMessage.result.message.content.imageUrl + '\')" src="' + getFriendMessage.result.message.content.thumbPath + '"/>';
                           html += '          </div>';
                           html += '          </div>';
                           html += '</div>';
                    }
                    //语音信息
                    else if (getFriendMessage.result.message.objectName == 'RC:VcMsg') {
                        html += '<div class="aui-chat-header">' + sj(getFriendMessage.result.message.sentTime) + '</div>';
                        html += '<div class="aui-chat-item aui-chat-left">';
                        html += '          <div class="aui-chat-media"><img src="' + friendTx + '" /></div>';
                        html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + friendName + '</div>';
                        html += '               <div class="aui-chat-content">';
                        html += '                        <div class="aui-chat-arrow"></div>';
                        html += ' <div onclick="play(this,\'' + getFriendMessage.result.message.content.voicePath + '\')" class="voice"> ' + getFriendMessage.result.message.content.duration + ' "</div>';
                        html += '          </div>';
                        html += '          </div>';
                        html += '</div>';
                   }
                   //将对方信息显示到窗口中
                   $api.append($api.dom('#msglist'), html);
                }

                //容器自动滚动至底部的处理，加个300演示防止回滚不成功
                Scoll(300);
            }
        });
        //获取与对方之间的历史交流信息
        getLatestMessages(friendId, 'PRIVATE');///////////////////////////////////改为friendId才对吧
        //设置下拉刷新模块
        api.setCustomRefreshHeaderInfo({
               bgColor : '#ffffff',
               image : {
                       pull : ['../image/loading1.png','../image/loading2.png','../image/loading3.png','../image/loading4.png','../image/loading5.png','../image/loading6.png','../image/loading7.png','../image/loading8.png','../image/loading1.png','../image/loading2.png','../image/loading3.png','../image/loading4.png','../image/loading5.png','../image/loading6.png','../image/loading7.png','../image/loading8.png'],
                       load : ['../image/loading8.png','../image/loading7.png','../image/loading6.png','../image/loading5.png','../image/loading4.png','../image/loading3.png','../image/loading2.png','../image/loading1.png','../image/loading8.png','../image/loading7.png','../image/loading6.png','../image/loading5.png','../image/loading4.png','../image/loading3.png','../image/loading2.png','../image/loading1.png'],
               }
            }, function() {
               getHistoryMessages(friendId, 'PRIVATE');///////////////////////////////////改为friendId才对吧
               setTimeout(function() {
                       api.refreshHeaderLoadDone();
               }, 3000)
        });
        //调用UIChatBox
        openChatBox();
        //监听键盘聊天框键盘弹出,用于调整聊天窗口高度
        chatBox.addEventListener({
                target: 'inputBar',
                name: 'move'
            }, function(ret,err){

                //由于键盘弹起有一定延迟，采用setTimeout
                setTimeout(function() {
                    //api.winHeight为键盘弹起后的lt.html的页面高度
                    //键盘弹起时，键盘高度ret.panelHeight与总页面高度api.winHeight是并列的
                    //当前框架的高度=屏幕高度-头部导航高度
                    // console.log("api.winHeight :"+api.winHeight);
                    // console.log("api.pageParam.head_h :"+api.pageParam.head_h);
                    // console.log("ret.inputBarHeight :"+ret.inputBarHeight);
                    // console.log("ret.panelHeight :"+ret.panelHeight);
                    // var frame_h = parseInt(api.winHeight)-parseInt(api.pageParam.head_h)-parseInt(ret.inputBarHeight);
                    // if(ret.panelHeight>0){
                    //     setTimeout(function() {
                    //         console.log(frame_h);
                    //         api.setFrameAttr({
                    //             name: 'lt_frame',
                    //             rect:{
                    //                 x:0,
                    //                 y:api.pageParam.head_h,
                    //                 w:'auto',
                    //                 h:frame_h
                    //             }
                    //         });
                    //     },1);
                    // }

                    /*
                    var frame_h = parseInt(api.winHeight)-parseInt(api.pageParam.head_h)-parseInt(ret.inputBarHeight);
                    if(ret.panelHeight>0){
                        setTimeout(function() {
                            api.setFrameAttr({
                                name: 'lt_frame',
                                rect:{
                                    x:0,
                                    y:api.pageParam.head_h,
                                    w:'auto',
                                    h:frame_h
                                }
                            });
                        },1);
                    }
                    else{
                        setTimeout(function() {
                            api.setFrameAttr({
                                name: 'lt_frame',
                                rect:{
                                    x:0,
                                    y:api.pageParam.head_h,
                                    w:'auto',
                                    h:frame_h
                            }
                        });
                    },1);
                    }*/
                },50);
        });
        //监听：按下录音按钮事件
        chatBox.addEventListener({
                target : 'recordBtn',
                name : 'press'
            }, function(ret, err) {
                time1 = new Date().getTime();        //录音开始计时
                if (ret) {
                        var savePath = 'fs://cgg_' + (+new Date()) + '.amr';    //录音文件保存路径，音频格式必须为amr
                        api.startRecord({
                                path : savePath
                        });
                }
        });
        //监听：move_out事件后，重新移入按钮区域
        chatBox.addEventListener({
                target : 'recordBtn',
                name : 'move_in'
            }, function(ret, err) {
                time1 = new Date().getTime();    //录音开始计时
                if (ret) {
                        var savePath = 'fs://cgg_' + (+new Date()) + '.amr';     //录音文件保存路径，音频格式必须为amr
                        api.startRecord({
                                path : savePath
                        });
                }
        });
        //监听：松开录音按钮
        chatBox.addEventListener({
                target : 'recordBtn',
                name : 'press_cancel'
            }, function(ret, err) {
                time2 = new Date().getTime() - time1;    //录音时间长度等于当前时间减去按下录音按钮时的时间。
                if (time2 <= 2000) {
                        stopRecord();
                        api.toast({
                                msg : '语音时间较短，请重新录音',
                                duration : 3000,
                                location : 'middle'
                        });
                } else if (time2 > 2000) {
                        api.stopRecord(function(ret, err) {
                                if (ret.duration > 0) {
                                        var path = ret.path;
                                        var duration = ret.duration;
                                        var extra = {
                                                id1 : myId,
                                                id2 : friendId,
                                                xm1 : myName,
                                                xm2 : friendName,
                                                tx1 : myTx,
                                                tx2 : friendTx
                                        };
                                        rong.sendVoiceMessage({
                                                conversationType : 'PRIVATE',
                                                targetId : friendId,
                                                voicePath : path,
                                                duration : duration,
                                                extra : JSON.stringify(extra)
                                        }, function(ret, err) {
                                                if (ret.status == 'prepare') {
                                                        yy = ret.result.message.content.voicePath;
                                                        time_len = ret.result.message.content.duration;
                                                        var html = '';
                                                        html += '<div class="aui-chat-item aui-chat-right">';
                                                        html += '          <div class="aui-chat-media"><img src="' + myTx + '" /></div>';
                                                        html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                                                        html += '               <div class="aui-chat-content_img" >';
                                                        html += '                        <div class="aui-chat-arrow"></div>';
                                                        html += '                    <div onclick="play(this,\'' + yy + '\')" class="voice"> ' + time_len + ' "</div>';
                                                        html += '               </div>';
                                                        html += '          </div>';
                                                        html += '</div>';
                                                        $api.append($api.dom('#msglist'), html);
                                                } else if (ret.status == 'success') {

                                                    Scoll(5);

                                                } else if (ret.status == 'error') {
                                                        api.toast({
                                                                msg : '语音发送失败'
                                                        });
                                                }
                                        });
                                }
                        });
                }
        });
        //监听：按下录音按钮后，从按钮移出并松开按钮
        chatBox.addEventListener({
                target : 'recordBtn',
                name : 'move_out_cancel'
            }, function(ret, err) {
                time2 = new Date().getTime() - time1;    //录音时间长度等于当前时间减去按下录音按钮时的时间。
                if (time2 <= 2000) {
                        stopRecord();
                        api.toast({
                                msg : '语音时间较短，请重新录音',
                                duration : 3000,
                                location : 'middle'
                        });
                } else if (time2 > 2000) {
                        api.stopRecord(function(ret, err) {
                                if (ret.duration > 0) {
                                        var path = ret.path;
                                        var duration = ret.duration;
                                        var extra = {
                                            id1 : myId,
                                            id2 : friendId,
                                            xm1 : myName,
                                            xm2 : friendName,
                                            tx1 : myTx,
                                            tx2 : friendTx
                                        };
                                        rong.sendVoiceMessage({
                                                conversationType : 'PRIVATE',
                                                targetId : friendId,//api.pageParam.id,
                                                voicePath : path,
                                                duration : duration,
                                                extra : JSON.stringify(extra)
                                        }, function(ret, err) {
                                                if (ret.status == 'prepare') {
                                                        yy = ret.result.message.content.voicePath;
                                                        time_len = ret.result.message.content.duration;
                                                        var html = '';
                                                        html += '<div class="aui-chat-item aui-chat-right">';
                                                        html += '          <div class="aui-chat-media"><img src="' + myTx + '" /></div>';
                                                        html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                                                        html += '               <div class="aui-chat-content_img">';
                                                        html += '                        <div class="aui-chat-arrow"></div>';
                                                        html += '<div onclick="play(this,\'' + yy + '\')" class="voice"> ' + time_len + ' "</div>';
                                                        html += '               </div>';
                                                        html += '          </div>';
                                                        html += '</div>';
                                                        $api.append($api.dom('#msglist'), html);
                                                } else if (ret.status == 'success') {


                                                        Scoll(5);
                                                } else if (ret.status == 'error') {
                                                        api.toast({
                                                                msg : '语音发送失败'
                                                        });
                                                }
                                        });
                                }
                        });
                }
        });
        }

/**********************
    打开UIChatBox
**********************/
function openChatBox(){
    chatBox = api.require('UIChatBox');
    chatBox.open(
    {
        placeholder: '',    //输入框的占位提示文本
        maxRows: 4,        //输入框显示的最大行数（高度自适应）
        emotionPath: 'widget://image/ChatBox/emotion',//'widget://image/emotion',        //自定义表情文件夹
        texts: {                            //聊天输入框模块可配置的文本
            recordBtn : {                    //录音按钮文字内容
                normalTitle: '按住 说话',
                activeTitle: '松开 结束'
            },
            sendBtn : {
                title : '发送'
            }
        },
        styles: {            //模块各部分的样式集合
            inputBar: {
                borderColor:  '#ececec',
                bgColor: '#fbfbfb'
            },
            inputBox: {
                borderColor: '#B3B3B3',
                bgColor: '#FFFFFF'
            },
            emotionBtn: {
                normalImg: 'widget://image/ChatBox/face1.png'
            },
            extrasBtn: {
                normalImg: 'widget://image/ChatBox/add1.png'
            },
            keyboardBtn: {
                normalImg: 'widget://image/ChatBox/key1.png'
            },
            speechBtn: {
                normalImg: 'widget://image/ChatBox/rec.png'
            },
            recordBtn: {
                normalBg: '#ffffff',
                activeBg: '#F4F4F4',
                color: '#5D5D5D',
                size: 14
            },
            indicator: {
                target: 'both',
                color: '#c4c4c4',
                activeColor: '#9e9e9e'
            },
            sendBtn : {
                titleColor : '#ffffff',
                bg : '#12b7f5',
                activeBg : '#1ba1d4',
                titleSize : 14
            }
        },
        extras: {        //点击附加功能按钮，打开的附加功能面板的按钮样式
            titleSize: 16,
            titleColor: '#a3a3a3',
            btns : [{
                    title : '相册图片',
                    normalImg : 'widget://image/ChatBox/img1.png',
                    activeImg : 'widget://image/ChatBox/img2.png'
            }, {
                    title : '相机拍照',
                    normalImg : 'widget://image/ChatBox/cam1.png',
                    activeImg : 'widget://image/ChatBox/cam2.png'
            }, {
                    title : '远程视频',
                    normalImg : 'widget://image/ChatBox/loc1.png',
                    activeImg : 'widget://image/ChatBox/loc2.png'
            }]
        }
    }, function(ret){
        //用户点击附加功能面板内的按钮
        if(ret.eventType == 'clickExtras'){
            //用户点击附加功能按钮的索引
            if (ret.index == 0) {                //图片
                getPicture('library');
            }else if (ret.index == 1) {          //拍摄
                getPicture('camera');
            }else if (ret.index == 2)
            {
                //-----------------拨打电话界面，很简单，就是点击拨打电话按钮，执行下面的代码即可
                api.execScript({
                    name: "main",
                    script: "makeCall('"+friendId+"','"+friendName+"','"+friendTx+"');"  //这里的targetId，就是接听电话人的ID，
                });
            }
            Scoll(5);
        }
        //用户输入文本后点击发送按钮
        if(ret.eventType == 'send'){
            if ($api.trimAll(ret.msg) == ''){
                api.toast({
                        msg : '不能发送空白消息',
                        duration : 1000,
                        location : 'center'
                });
            }
            else{
                var extra = {
                    id1 : myId,
                    id2 : friendId,
                    xm1 : myName,
                    xm2 : friendName,
                    tx1 : myTx,
                    tx2 : friendTx
                };
                //通过sendEvent将发送内容广播，消息页面接收并广播回来
                //单聊文字消息类型
                rong.sendTextMessage({
                        conversationType : 'PRIVATE',
                        targetId : friendId,
                        text : ret.msg,
                        extra : JSON.stringify(extra)
                }, function(ret, err) {
                    //这个函数体应该执行两次,第一次发送 status:'prepare',第二次发送 status:'success'或'error'
                    //status'success'或'error'时，只包含ret.result.message.messageId这条信息，没有ret.result.message.content.text
                    //alert(JSON.stringify(ret));
                    if (ret.status == 'prepare')
                    {
                        var html = '';
                        var xx = ret.result.message.content.text.replace(reg, function(a, b) {
                                return face[a] ? face[a] : a;});
                        html += '<div class="aui-chat-item aui-chat-right">';
                        html += '          <div class="aui-chat-media"><img src="' + myTx + '" /></div>';
                        html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                        html += '               <div class="aui-chat-content">';
                        html += '                        <div class="aui-chat-arrow"></div>';
                        html += xx;
                        html += '               </div>';
                        html += '          </div>';
                        html += '</div>';
                        $api.append($api.dom('#msglist'), html);
                    }
                    else if (ret.status == 'success')
                    {
                        Scoll(5);
                    }
                    else{}
                });
            }
        }
        }
        );
        }


//获取最近历史信息
function getLatestMessages(targetId, conversationType) {
            rong.getLatestMessages({
                    conversationType : conversationType,
                    targetId : targetId,
                    count : 4
                }, function(ret, err) {
                    if (ret.status == 'success') {
                            if (ret.result && ret.result.length > 0) {
                                    var html = '';
                                    //倒序遍历数组将获取到的聊天记录
                                    for (var i = ret.result.length - 1; i >= 0; i--) {
                                            var rs = ret.result[i];
                                            //将附加信息数据json格式转换
                                            var extra = transExtra(rs.content.extra);
                                            //extra.xm1 == 和rs.messageDirection == 'SEND'说明这条数据是自己发送的，否则就是对方发送的
                                            if (extra.xm1 == myName) {
                                                    var msgid = extra.id2;
                                                    var zh = extra.xm2;
                                                    var tx = extra.tx2;
                                            } else {
                                                    var msgid = extra.id1;
                                                    var zh = extra.xm1;
                                                    var tx = extra.tx1;
                                            }
                                            if (rs.objectName == 'RC:TxtMsg') {
                                                    jsxx = rs.content.text.replace(reg, function(a, b) {
                                                            return face[a] ? face[a] : a;
                                                    });
                                                    if (rs.messageDirection == 'SEND') {
                                                            html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                            html += '<div class="aui-chat-item aui-chat-right">';
                                                            html += '          <div class="aui-chat-media"><img src="' + myTx + '" /></div>';
                                                            html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                                                            html += '               <div class="aui-chat-content">';
                                                            html += '                        <div class="aui-chat-arrow"></div>';
                                                            html += jsxx;
                                                            html += '               </div>';
                                                            html += '          </div>';
                                                            html += '</div>';
                                                    } else {
                                                            html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                            html += '<div class="aui-chat-item aui-chat-left">';
                                                            html += '          <div class="aui-chat-media"><img src="' + tx + '" /></div>';
                                                            html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + zh + '</div>';
                                                            html += '               <div class="aui-chat-content">';
                                                            html += '                        <div class="aui-chat-arrow"></div>';
                                                            html += jsxx;
                                                            html += '               </div>';
                                                            html += '          </div>';
                                                            html += '</div>';
                                                    }
                                            } else if (rs.objectName == 'RC:ImgMsg') {
                                                    var bpic = rs.content.imageUrl;
                                                    var spic = rs.content.thumbPath;
                                                    if (rs.messageDirection == 'SEND') {
                                                            html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                            html += '<div class="aui-chat-item aui-chat-right">';
                                                            html += '          <div class="aui-chat-media"><img src="' + myTx + '" /></div>';
                                                            html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                                                            html += '               <div class="aui-chat-content_img">';
                                                            html += '                        <div class="aui-chat-arrow"></div>';
                                                            html += '               <img onclick="openImage(\'' + bpic + '\')" src="' + spic + '"/>';
                                                            html += '          </div>';
                                                            html += '          </div>';
                                                            html += '</div>';
                                                    } else {
                                                            html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                            html += '<div class="aui-chat-item aui-chat-left">';
                                                            html += '          <div class="aui-chat-media"><img src="' + tx + '" /></div>';
                                                            html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + zh + '</div>';
                                                            html += '               <div class="aui-chat-content_img">';
                                                            html += '                        <div class="aui-chat-arrow"></div>';
                                                            html += '               <img onclick="openImage(\'' + bpic + '\')" src="' + spic + '"/>';
                                                            html += '          </div>';
                                                            html += '          </div>';
                                                            html += '</div>';
                                                    }
                                            } else if (rs.objectName == 'RC:VcMsg') {
                                                    if (rs.messageDirection == 'SEND') {
                                                            html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                            html += '<div class="aui-chat-item aui-chat-right">';
                                                            html += '          <div class="aui-chat-media"><img src="' + myTx + '" /></div>';
                                                            html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                                                            html += '               <div class="aui-chat-content_img">';
                                                            html += '                        <div class="aui-chat-arrow"></div>';
                                                            html += '<div onclick="play(this,\'' + rs.content.voicePath + '\')" class="voice"> ' + rs.content.duration + ' "</div>';
                                                            html += '          </div>';
                                                            html += '          </div>';
                                                            html += '</div>';
                                                    } else {
                                                            html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                            html += '<div class="aui-chat-item aui-chat-left">';
                                                            html += '          <div class="aui-chat-media"><img src="' + tx + '" /></div>';
                                                            html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + zh + '</div>';
                                                            html += '               <div class="aui-chat-content_img">';
                                                            html += '                        <div class="aui-chat-arrow"></div>';
                                                            html += '<div onclick="play(this,\'' + rs.content.voicePath + '\')" class="voice"> ' + rs.content.duration + ' "</div>';
                                                            html += '          </div>';
                                                            html += '          </div>';
                                                            html += '</div>';
                                                    }
                                            }
                                    }
                                    $api.html($api.dom('#msglist'), html);
                                    Scoll(300);
                            }
                    }
            });
        }

//下拉加载更长久的历史记录
function getHistoryMessages(targetId, conversationType) {
                   //var rong = api.require('rongCloud2');
                   //获取aui-chat-header类型的所有标签中的第一个标签id
                   var oldid = $(".aui-chat-header").first().data("id");
                   rong.getHistoryMessages({
                           conversationType : conversationType,
                           targetId : targetId,
                           oldestMessageId : oldid,
                           count : 8
                       }, function(ret, err) {
                           if (ret.status == 'success') {
                                   var html = '';
                                   if (ret.result && ret.result.length > 0) {
                                           for (var i = ret.result.length - 1; i >= 0; i--) {
                                                   var rs = ret.result[i];
                                                   var extra = transExtra(rs.content.extra);
                                                   if (extra.xm1 == myName) {
                                                           var msgid = extra.id2;
                                                           var zh = extra.xm2;
                                                           var tx = extra.tx2;
                                                   } else {
                                                           var msgid = extra.id1;
                                                           var zh = extra.xm1;
                                                           var tx = extra.tx1;
                                                   }
                                                   if (rs.objectName == 'RC:TxtMsg') {
                                                           jsxx = rs.content.text.replace(reg, function(a, b) {
                                                                   return face[a] ? face[a] : a;
                                                           });
                                                           if (rs.messageDirection == 'SEND') {
                                                                   html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                                   html += '<div class="aui-chat-item aui-chat-right">';
                                                                   html += '          <div class="aui-chat-media"><img src="' + myTx + '" /></div>';
                                                                   html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                                                                   html += '               <div class="aui-chat-content">';
                                                                   html += '                        <div class="aui-chat-arrow"></div>';
                                                                   html += jsxx;
                                                                   html += '               </div>';
                                                                   html += '          </div>';
                                                                   html += '</div>';
                                                           } else {
                                                                   html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                                   html += '<div class="aui-chat-item aui-chat-left">';
                                                                   html += '          <div class="aui-chat-media"><img src="' + tx + '" /></div>';
                                                                   html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + zh + '</div>';
                                                                   html += '               <div class="aui-chat-content">';
                                                                   html += '                        <div class="aui-chat-arrow"></div>';
                                                                   html += jsxx;
                                                                   html += '               </div>';
                                                                   html += '          </div>';
                                                                   html += '</div>';
                                                           }
                                                   } else if (rs.objectName == 'RC:ImgMsg') {
                                                           var bpic = rs.content.imageUrl;
                                                           var spic = rs.content.thumbPath;
                                                           if (rs.messageDirection == 'SEND') {
                                                                   html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                                   html += '<div class="aui-chat-item aui-chat-right">';
                                                                   html += '          <div class="aui-chat-media" ><img src="' + myTx + '" /></div>';
                                                                   html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                                                                   html += '               <div class="aui-chat-content_img">';
                                                                   html += '                        <div class="aui-chat-arrow"></div>';
                                                                   html += '               <img onclick="openImage(\'' + bpic + '\')" src="' + spic + '"/>';
                                                                   html += '          </div>';
                                                                   html += '          </div>';
                                                                   html += '</div>';
                                                           } else {
                                                                   html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                                   html += '<div class="aui-chat-item aui-chat-left">';
                                                                   html += '          <div class="aui-chat-media"><img src="' + tx + '" /></div>';
                                                                   html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + zh + '</div>';
                                                                   html += '               <div class="aui-chat-content_img">';
                                                                   html += '                        <div class="aui-chat-arrow"></div>';
                                                                   html += '               <img onclick="openImage(\'' + bpic + '\')" src="' + spic + '"/>';
                                                                   html += '          </div>';
                                                                   html += '          </div>';
                                                                   html += '</div>';
                                                           }
                                                   } else if (rs.objectName == 'RC:VcMsg') {
                                                           if (rs.messageDirection == 'SEND') {
                                                                   html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                                   html += '<div class="aui-chat-item aui-chat-right">';
                                                                   html += '          <div class="aui-chat-media" ><img src="' + myTx + '" /></div>';
                                                                   html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                                                                   html += '               <div class="aui-chat-content_img">';
                                                                   html += '                        <div class="aui-chat-arrow"></div>';
                                                                   html += '<div onclick="play(this,\'' + rs.content.voicePath + '\')" class="voice"> ' + rs.content.duration + ' "</div>';
                                                                   html += '          </div>';
                                                                   html += '          </div>';
                                                                   html += '</div>';
                                                           } else {
                                                                   html += '<div class="aui-chat-header" data-id="' + rs.messageId + '">' + sj(rs.sentTime) + '</div>';
                                                                   html += '<div class="aui-chat-item aui-chat-left">';
                                                                   html += '          <div class="aui-chat-media"><img src="' + tx + '" /></div>';
                                                                   html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + zh + '</div>';
                                                                   html += '               <div class="aui-chat-content_img">';
                                                                   html += '                        <div class="aui-chat-arrow"></div>';
                                                                   html += '<div onclick="play(this,\'' + rs.content.voicePath + '\')" class="voice"> ' + rs.content.duration + ' "</div>';
                                                                   html += '          </div>';
                                                                   html += '          </div>';
                                                                   html += '</div>';
                                                           }
                                                   }
                                           }
                                           $api.prepend($api.dom('#msglist'), html);
                                           //Scoll(300);
                                           api.refreshHeaderLoadDone();
                                   } else {
                                           api.toast({
                                                   msg : '木有了消息啦…'
                                           });
                                           api.refreshHeaderLoadDone();
                                   }
                           }
                   });
        }

//发送图像
function getPicture(type) {
    api.getPicture({
            sourceType : type,        //图片库 or 拍摄类型
            encodingType : 'jpg',     //图片
            mediaValue : 'pic',       //返回图片类型
            destinationType : 'url',  //指定 返回数据 为"选取的图片地址"
            allowEdit : false,        //可以选择图片后进行编辑
            quality : 100,            //jpg格式图片质量
            saveToPhotoAlbum : false  //拍照或录制视频后不保存
    }, function(ret, err) {
            if (ret) {
                    var extra = {
                        id1 : myId,
                        id2 : friendId,
                        xm1 : myName,
                        xm2 : friendName,
                        tx1 : myTx,
                        tx2 : friendTx
                    };
                    rong.sendImageMessage({
                            conversationType : 'PRIVATE',
                            targetId : friendId,
                            imagePath : ret.data,
                            extra : JSON.stringify(extra)
                    }, function(ret, err) {
                            if (ret.status == 'prepare') {
                                    var bpic = ret.result.message.content.imageUrl;
                                    var spic = ret.result.message.content.thumbPath;
                                    var html = '';
                                    html += '<div class="aui-chat-item aui-chat-right">';
                                    html += '          <div class="aui-chat-media"><img src="' + myTx + '" /></div>';
                                    html += '          <div class="aui-chat-inner"><div class="aui-chat-name">' + myName + '</div>';
                                    html += '               <div class="aui-chat-content_img">';
                                    html += '                        <div class="aui-chat-arrow"></div>';
                                    html += '               <img onclick="openImage(\'' + bpic + '\')" src="' + spic + '"/>';
                                    html += '          </div>';
                                    html += '          </div>';
                                    html += '</div>';
                                    $api.append($api.dom('#msglist'), html);
                            }
                    });
                    chatBox.closeBoard();
            } else {
                    api.toast({
                            msg : '图像获取失败',
                            duration : 3000,
                            location : 'bottom'
                    });
                    chatBox.closeBoard();
            }
    });
}

//打开图像
function openImage(path) {
   var imageBrowser = api.require('imageBrowser');
   imageBrowser.openImages({
           imageUrls : [path]
   });
}

//终止录音
function stopRecord() {
       api.stopRecord(function(ret, err) {
       });
}

//播放录音
function play(el, path) {
       //点击语音图标时会执行函数play（）当播放语音时改变样式voice的背景图像，语音播放完毕voice样式的背景图像还原
       $api.css(el,'background-image:url(../image/ChatBox/playing.gif)');
       api.startPlay({
               path : path
       }, function() {
               $api.css(el,'background-image:url(../image/ChatBox/stop.png)');
       });
}

//时间差计算
function sj(sj) {
        var nowt = new Date().getTime();
        var a = new Date(parseInt(sj));
        var b = new Date(parseInt(nowt));
        var date1 = Date.parse(format(a, 4));
        var date2 = Date.parse(format(b, 4));
        var xxsj = Math.ceil((date2 - date1) / (60 * 1000))
        if (xxsj <= 1 && xxsj >= 0) {
                return "就刚才";
        }
        else if (xxsj <= 10 && xxsj > 1) {
                return xxsj + "分钟前";
        } else if (xxsj <= 60 && xxsj > 10) {
                return format(a, 1);
        } else if (xxsj <= 1440 && xxsj > 60) {
                return format(a, 1);
        } else if (xxsj <= 10080 && xxsj > 1440) {
                return format(a, 2);
        } else if (xxsj > 10080) {
                return format(a, 3);
        } else {
                return format(a, 3);
        }
}

//格式化时间
function format(now, type) {
        var show_day = new Array('星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六');
        var year = now.getFullYear().toString();
        var month = (now.getMonth() + 1).toString();
        var day = (now.getDate()).toString();
        var tian = now.getDay().toString();
        var hour = (now.getHours()).toString();
        var minute = (now.getMinutes()).toString();
        var second = (now.getSeconds()).toString();
        if (hour.length == 1) {
                hour = "0" + hour;
        }
        if (minute.length == 1) {
                minute = "0" + minute;
        }
        if (second.length == 1) {
                second = "0" + second;
        }
        if (type == 1) {
                var dateTime = hour + ":" + minute;
        } else if (type == 2) {
                var dateTime = show_day[tian] + " " + hour + ":" + minute
        } else if (type == 3) {
                var dateTime = year + "-" + month + "-" + day
        } else if (type == 4) {
                var dateTime = year + "/" + month + "/" + day + " " + hour + ":" + minute + ":" + second;
        } else if (type == 5) {
                var dateTime = show_day[tian];
        }
        return dateTime;
}

//json格式转换
function transExtra(arg) {
       var result = '';
       try {
               result = eval('(' + arg + ')');
       } catch (e) {
               result = arg.slice(1, -1);
       } finally {
       }
       return result;
}

//经过time毫秒后，页面回滚到底部
function Scoll(time){
    setTimeout(function() {api.pageDown({bottom:true},function( ret, err ){});},time);
}

//表情集合
var face = {
    '[微笑]' : '<span><img src="../image/ChatBox/emotion/Expression_1.png"  width="28"/></span>',
    '[撇嘴]' : '<span><img src="../image/ChatBox/emotion/Expression_2.png"  width="28" /></span>',
    '[色]' : '<span><img src="../image/ChatBox/emotion/Expression_3.png"  width="28" /></span>',
    '[发呆]' : '<span><img src="../image/ChatBox/emotion/Expression_4.png"  width="28" /></span>',
    '[得意]' : '<span><img src="../image/ChatBox/emotion/Expression_5.png"  width="28" /></span>',
    '[流泪]' : '<span><img src="../image/ChatBox/emotion/Expression_6.png"  width="28" /></span>',
    '[害羞]' : '<span><img src="../image/ChatBox/emotion/Expression_7.png"  width="28" /></span>',
    '[闭嘴]' : '<span><img src="../image/ChatBox/emotion/Expression_8.png"  width="28" /></span>',
    '[睡]' : '<span><img src="../image/ChatBox/emotion/Expression_9.png"  width="28" /></span>',
    '[大哭]' : '<span><img src="../image/ChatBox/emotion/Expression_10.png"  width="28"/></span>',
    '[尴尬]' : '<span><img src="../image/ChatBox/emotion/Expression_11.png"  width="28"/></span>',
    '[发怒]' : '<span><img src="../image/ChatBox/emotion/Expression_12.png"  width="28"/></span>',
    '[调皮]' : '<span><img src="../image/ChatBox/emotion/Expression_13.png"  width="28" /></span>',
    '[呲牙]' : '<span><img src="../image/ChatBox/emotion/Expression_14.png"  width="28" /></span>',
    '[惊讶]' : '<span><img src="../image/ChatBox/emotion/Expression_15.png"  width="28" /></span>',
    '[难过]' : '<span><img src="../image/ChatBox/emotion/Expression_16.png"  width="28" /></span>',
    '[酷]' : '<span><img src="../image/ChatBox/emotion/Expression_17.png"  width="28" /></span>',
    '[冷汗]' : '<span><img src="../image/ChatBox/emotion/Expression_18.png"  width="28" /></span>',
    '[抓狂]' : '<span><img src="../image/ChatBox/emotion/Expression_19.png"  width="28" /></span>',
    '[吐]' : '<span><img src="../image/ChatBox/emotion/Expression_20.png"  width="28" /></span>',
    '[偷笑]' : '<span><img src="../image/ChatBox/emotion/Expression_21.png"  width="28" /></span>',
    '[愉快]' : '<span><img src="../image/ChatBox/emotion/Expression_22.png"  width="28" /></span>',
    '[白眼]' : '<span><img src="../image/ChatBox/emotion/Expression_23.png"  width="28" /></span>',
    '[傲慢]' : '<span><img src="../image/ChatBox/emotion/Expression_24.png"  width="28" /></span>',
    '[饥饿]' : '<span><img src="../image/ChatBox/emotion/Expression_25.png"  width="28" /></span>',
    '[困]' : '<span><img src="../image/ChatBox/emotion/Expression_26.png"  width="28" /></span>',
    '[恐惧]' : '<span><img src="../image/ChatBox/emotion/Expression_27.png"  width="28" /></span>',
    '[流汗]' : '<span><img src="../image/ChatBox/emotion/Expression_28.png"  width="28" /></span>',
    '[憨笑]' : '<span><img src="../image/ChatBox/emotion/Expression_29.png"  width="28" /></span>',
    /*从这*/
    '[悠闲]' : '<span><img src="../image/ChatBox/emotion/Expression_30.png"  width="28" /></span>',
    '[奋斗]' : '<span><img src="../image/ChatBox/emotion/Expression_31.png"  width="28" /></span>',
    '[咒骂]' : '<span><img src="../image/ChatBox/emotion/Expression_32.png"  width="28" /></span>',
    '[疑问]' : '<span><img src="../image/ChatBox/emotion/Expression_33.png"  width="28" /></span>',
    '[嘘]' : '<span><img src="../image/ChatBox/emotion/Expression_34.png"  width="28" /></span>',
    '[晕]' : '<span><img src="../image/ChatBox/emotion/Expression_35.png"  width="28" /></span>',
    '[疯了]' : '<span><img src="../image/ChatBox/emotion/Expression_36.png"  width="28" /></span>',
    '[衰]' : '<span><img src="../image/ChatBox/emotion/Expression_37.png"  width="28" /></span>',
    '[骷髅]' : '<span><img src="../image/ChatBox/emotion/Expression_38.png"  width="28" /></span>',
    '[敲打]' : '<span><img src="../image/ChatBox/emotion/Expression_39.png"  width="28"/></span>',
    '[再见]' : '<span><img src="../image/ChatBox/emotion/Expression_40.png"  width="28"/></span>',
    '[擦汗]' : '<span><img src="../image/ChatBox/emotion/Expression_41.png"  width="28"/></span>',
    '[抠鼻]' : '<span><img src="../image/ChatBox/emotion/Expression_42.png"  width="28" /></span>',
    '[鼓掌]' : '<span><img src="../image/ChatBox/emotion/Expression_43.png"  width="28" /></span>',
    '[糗大了]' : '<span><img src="../image/ChatBox/emotion/Expression_44.png"  width="28" /></span>',
    '[坏笑]' : '<span><img src="../image/ChatBox/emotion/Expression_45.png"  width="28" /></span>',
    '[左哼哼]' : '<span><img src="../image/ChatBox/emotion/Expression_46.png"  width="28" /></span>',
    '[右哼哼]' : '<span><img src="../image/ChatBox/emotion/Expression_47.png"  width="28" /></span>',
    '[哈欠]' : '<span><img src="../image/ChatBox/emotion/Expression_48.png"  width="28" /></span>',
    '[鄙视]' : '<span><img src="../image/ChatBox/emotion/Expression_49.png"  width="28" /></span>',
    '[委屈]' : '<span><img src="../image/ChatBox/emotion/Expression_50.png"  width="28" /></span>',
    '[快哭了]' : '<span><img src="../image/ChatBox/emotion/Expression_51.png"  width="28" /></span>',
    '[阴险]' : '<span><img src="../image/ChatBox/emotion/Expression_52.png"  width="28" /></span>',
    '[亲亲]' : '<span><img src="../image/ChatBox/emotion/Expression_53.png"  width="28" /></span>',
    '[吓]' : '<span><img src="../image/ChatBox/emotion/Expression_54.png"  width="28" /></span>',
    '[可怜]' : '<span><img src="../image/ChatBox/emotion/Expression_55.png"  width="28" /></span>',
    '[菜刀]' : '<span><img src="../image/ChatBox/emotion/Expression_56.png"  width="28" /></span>',
    '[西瓜]' : '<span><img src="../image/ChatBox/emotion/Expression_57.png"  width="28" /></span>',
    '[啤酒]' : '<span><img src="../image/ChatBox/emotion/Expression_58.png"  width="28" /></span>',
    '[篮球]' : '<span><img src="../image/ChatBox/emotion/Expression_59.png"  width="28" /></span>',
    '[乒乓]' : '<span><img src="../image/ChatBox/emotion/Expression_60.png"  width="28" /></span>',
    '[咖啡]' : '<span><img src="../image/ChatBox/emotion/Expression_61.png"  width="28" /></span>',
    '[饭]' : '<span><img src="../image/ChatBox/emotion/Expression_62.png"  width="28" /></span>',
    '[猪头]' : '<span><img src="../image/ChatBox/emotion/Expression_63.png"  width="28" /></span>',
    '[玫瑰]' : '<span><img src="../image/ChatBox/emotion/Expression_64.png"  width="28" /></span>',
    '[凋谢]' : '<span><img src="../image/ChatBox/emotion/Expression_65.png"  width="28" /></span>',
    '[嘴唇]' : '<span><img src="../image/ChatBox/emotion/Expression_66.png"  width="28" /></span>',
    '[爱心]' : '<span><img src="../image/ChatBox/emotion/Expression_67.png"  width="28" /></span>',
    '[心碎]' : '<span><img src="../image/ChatBox/emotion/Expression_68.png"  width="28"/></span>',
    '[蛋糕]' : '<span><img src="../image/ChatBox/emotion/Expression_69.png"  width="28"/></span>',
    '[闪电]' : '<span><img src="../image/ChatBox/emotion/Expression_70.png"  width="28"/></span>',
    '[炸弹]' : '<span><img src="../image/ChatBox/emotion/Expression_71.png"  width="28" /></span>',
    '[刀]' : '<span><img src="../image/ChatBox/emotion/Expression_72.png"  width="28" /></span>',
    '[足球]' : '<span><img src="../image/ChatBox/emotion/Expression_73.png"  width="28" /></span>',
    '[瓢虫]' : '<span><img src="../image/ChatBox/emotion/Expression_74.png"  width="28" /></span>',
    '[便便]' : '<span><img src="../image/ChatBox/emotion/Expression_75.png"  width="28" /></span>',
    '[月亮]' : '<span><img src="../image/ChatBox/emotion/Expression_76.png"  width="28" /></span>',
    '[太阳]' : '<span><img src="../image/ChatBox/emotion/Expression_77.png"  width="28" /></span>',
    '[礼物]' : '<span><img src="../image/ChatBox/emotion/Expression_78.png"  width="28" /></span>',
    '[拥抱]' : '<span><img src="../image/ChatBox/emotion/Expression_79.png"  width="28" /></span>',
    '[强]' : '<span><img src="../image/ChatBox/emotion/Expression_80.png"  width="28" /></span>',
    '[弱]' : '<span><img src="../image/ChatBox/emotion/Expression_81.png"  width="28" /></span>',
    '[握手]' : '<span><img src="../image/ChatBox/emotion/Expression_82.png"  width="28" /></span>',
    '[胜利]' : '<span><img src="../image/ChatBox/emotion/Expression_83.png"  width="28" /></span>',
    '[抱拳]' : '<span><img src="../image/ChatBox/emotion/Expression_84.png"  width="28" /></span>',
    '[勾引]' : '<span><img src="../image/ChatBox/emotion/Expression_85.png"  width="28" /></span>',
    '[拳头]' : '<span><img src="../image/ChatBox/emotion/Expression_86.png"  width="28" /></span>',
    '[差劲]' : '<span><img src="../image/ChatBox/emotion/Expression_87.png"  width="28" /></span>',
    '[爱你]' : '<span><img src="../image/ChatBox/emotion/Expression_88.png"  width="28" /></span>',
    '[NO]' : '<span><img src="../image/ChatBox/emotion/Expression_89.png"  width="28" /></span>',
    '[OK]' : '<span><img src="../image/ChatBox/emotion/Expression_90.png"  width="28" /></span>',
    '[爱情]' : '<span><img src="../image/ChatBox/emotion/Expression_91.png"  width="28" /></span>',
    '[飞吻]' : '<span><img src="../image/ChatBox/emotion/Expression_92.png"  width="28" /></span>',
    '[跳跳]' : '<span><img src="../image/ChatBox/emotion/Expression_93.png"  width="28" /></span>',
    '[发抖]' : '<span><img src="../image/ChatBox/emotion/Expression_94.png"  width="28" /></span>',
    '[怄火]' : '<span><img src="../image/ChatBox/emotion/Expression_95.png"  width="28" /></span>',
    '[转圈]' : '<span><img src="../image/ChatBox/emotion/Expression_96.png"  width="28" /></span>',
    '[磕头]' : '<span><img src="../image/ChatBox/emotion/Expression_97.png"  width="28"/></span>',
    '[回头]' : '<span><img src="../image/ChatBox/emotion/Expression_98.png"  width="28"/></span>',
    '[跳绳]' : '<span><img src="../image/ChatBox/emotion/Expression_99.png"  width="28"/></span>',
    '[投降]' : '<span><img src="../image/ChatBox/emotion/Expression_100.png"  width="28" /></span>',
    '[激动]' : '<span><img src="../image/ChatBox/emotion/Expression_101.png"  width="28" /></span>',
    '[街舞]' : '<span><img src="../image/ChatBox/emotion/Expression_102.png"  width="28" /></span>',
    '[献吻]' : '<span><img src="../image/ChatBox/emotion/Expression_103.png"  width="28" /></span>',
    '[左太极]' : '<span><img src="../image/ChatBox/emotion/Expression_104.png"  width="28" /></span>',
    '[右太极]' : '<span><img src="../image/ChatBox/emotion/Expression_105.png"  width="28" /></span>',
    '[哈哈]' : '<span><img src="../image/ChatBox/emotion/Expression_105.png"  width="28" /></span>'
};
</script>

</html>
